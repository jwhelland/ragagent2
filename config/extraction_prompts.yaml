# LLM prompts for entity and relationship extraction

entity_extraction:
  system: |
    You are an expert at extracting structured entities from technical and engineering documents.
    Follow the provided schema exactly and keep outputs deterministic. Avoid Markdown,
    preambles, or explanations. Prefer evidence-backed entities; when nothing qualifies, respond
    with an object whose "entities" value is an empty list. Use the canonical name found in the text
    (preserve capitalization and spaces) and keep abbreviations in aliases.

  user_template: |
    Extract entities from the text using the schema and allowed labels below.

    Entity types (choose only these):
    - SYSTEM: system-level or facility-level system providing a top-level function
    - SUBSYSTEM: major platform partition (power, communications, thermal, GNC, payload)
    - COMPONENT: hardware or software element inside a subsystem
    - PARAMETER: tunable value, telemetry field, or threshold
    - PROCEDURE: multi-step operational activity or checklist
    - PROCEDURE_STEP: individual action within a procedure
    - CONCEPT: domain concept or physical phenomenon
    - DOCUMENT: referenced documents, specifications, ICDs, handbooks
    - STANDARD: published standard or protocol (e.g., CCSDS, ECSS)
    - ANOMALY: failure mode, issue, or mitigation step
    - TABLE: table referenced by number or caption
    - FIGURE: figure referenced by number or caption
    - ORGANIZATION: company, institution, agency, or research center (e.g., NASA, SpaceX, JPL)
    - PERSON: individual human entity (e.g., Elon Musk, engineers, operators)

    Output JSON schema (apply strictly):
    - Root object with required key "entities".
    - "entities": array of entity objects.
    - Entity object required fields: name (string), type (enum above),
      description (concise, evidence-based), confidence (float 0-1).
    - Optional fields: aliases (unique strings), source_sentence (verbatim supporting text).

    Extraction rules:
    - Only emit entities supported by the text; do not invent values or fill with "N/A".
    - Merge abbreviations into aliases; keep canonical name descriptive but concise.
    - Provide source_sentence when possible by quoting the shortest text that proves the entity.
    - Prefer domain-relevant entities; ignore generic nouns and units unless called out as parameters.

    Text to analyze:
    {chunk_text}

    Document context:
    - Title: {document_title}
    - Section: {section_title}
    - Page(s): {page_numbers}

    Return ONLY compact JSON (no prose or Markdown):
    {{
      "entities": [
        {{
          "name": "example_entity",
          "type": "COMPONENT",
          "description": "what it is and its role",
          "aliases": ["short name"],
          "source_sentence": "quoted evidence from the chunk",
          "confidence": 0.87
        }}
      ]
    }}

    Few-shot reference:
    Input: "The Electrical Power Subsystem (EPS) manages battery charging and solar array deployment."
    Output:
    {{
      "entities": [
        {{
          "name": "electrical_power_subsystem",
          "type": "SUBSYSTEM",
          "description": "Manages power generation, storage, and distribution",
          "aliases": ["EPS", "power subsystem"],
          "source_sentence": "The Electrical Power Subsystem (EPS) manages battery charging and solar array deployment.",
          "confidence": 0.95
        }},
        {{
          "name": "solar_array",
          "type": "COMPONENT",
          "description": "Array providing solar power for charging and deployment",
          "aliases": ["solar panel array"],
          "source_sentence": "manages battery charging and solar array deployment",
          "confidence": 0.90
        }}
      ]
    }}

relationship_extraction:
  system: |
    You are an expert at identifying relationships between entities in technical documents.
    Use the provided schema and keep outputs machine-parsable JSON only. Prefer concise,
    evidence-backed descriptions; when no relationships are present, respond with an object whose
    "relationships" value is an empty list.

  user_template: |
    Identify relationships between entities from the text. Use known entities when provided.

    Relationship types (choose only these):
    - PART_OF: target is a parent of source
    - CONTAINS: source includes target as a part or module
    - IS_A: source is a specific instance or subtype of target
    - DEPENDS_ON: source functionally relies on target
    - CONTROLS: source commands or actuates target
    - MONITORS: source observes or measures target
    - PROVIDES: source supplies a resource or capability to target
    - PROVIDES_POWER_TO: source supplies electrical power to target
    - SENDS_DATA_TO: source transmits data/telemetry to target
    - SUPPORTS: source physically or functionally supports target
    - REQUIRES: source needs target to function
    - CONNECTS_TO: source is physically or logically linked to target
    - TRIGGERS: source initiates an action or state in target
    - CAUSES: source directly results in target event/state
    - REFERENCES: source cites or mentions target
    - PRECEDES: source step occurs before target step
    - REQUIRES_CHECK: source requires verification of target
    - AFFECTS: source impacts or changes target state
    - IMPLEMENTS: source implements or fulfills target standard or requirement
    - SIMILAR_TO: source is similar to target
    - CAUSED_BY: source is caused by target
    - MITIGATED_BY: source is mitigated by target
    - REFERENCES_TABLE / REFERENCES_FIGURE: source points to a table/figure
    - DEFINED_IN_TABLE / SHOWN_IN_FIGURE: target defines or shows source
    - CONTAINS_TABLE / CONTAINS_FIGURE: source section contains the table/figure
    - CROSS_REFERENCES: mutual references

    Output JSON schema:
    - Root object with required key "relationships".
    - "relationships": array of relationship objects.
    - Relationship required fields: source (string), source_type (enum from entity types), type (enum above), target (string), target_type (enum from entity types),
      description (concise evidence-backed clause), confidence (float 0-1).
    - Optional fields: bidirectional (boolean), evidence (verbatim supporting text).

    Extraction rules:
    - Use entity names from the known entity list when they match; otherwise use the canonical name found in the text.
    - Provide source_type and target_type even for known entities; this helps validate and discover missed entities.
    - Avoid duplicate inverse pairs; set bidirectional to true when the text states mutual linkage.
    - Prefer structural, functional, or procedural relations; ignore vague co-occurrence.
    - For IS_A: only use when target is a category/type, not an attribute or adjective.
    - For SIMILAR_TO: only use when entities serve similar purposes, not just mentioned together.
    - If no valid relationship is present, return an empty list.

    Text:
    {chunk_text}

    Known entities in this chunk:
    {entities_list}

    Document context:
    - Title: {document_title}
    - Section: {section_title}

    Return ONLY JSON:
    {{
      "relationships": [
        {{
          "source": "battery",
          "source_type": "COMPONENT",
          "type": "DEPENDS_ON",
          "target": "solar_array",
          "target_type": "COMPONENT",
          "description": "Battery relies on solar array output for charging",
          "evidence": "The battery depends on the solar array for charging during daylight passes.",
          "confidence": 0.92,
          "bidirectional": false
        }}
      ]
    }}

    Few-shot references:
    1) Text: "The thermal control system monitors temperature sensors located in each subsystem."
       Output:
       {{
         "relationships": [
           {{
             "source": "thermal_control_system",
             "source_type": "SUBSYSTEM",
             "type": "MONITORS",
             "target": "temperature_sensor",
             "target_type": "COMPONENT",
             "description": "Thermal control reads temperature sensors for each subsystem",
             "confidence": 0.90,
             "bidirectional": false
           }}
         ]
       }}
    2) Text: "Procedure step 3 (Verify Table 2) ensures transponder configuration."
       Output:
       {{
         "relationships": [
           {{
             "source": "procedure_step_3",
             "source_type": "PROCEDURE_STEP",
             "type": "REFERENCES_TABLE",
             "target": "table_2",
             "target_type": "TABLE",
             "description": "Step 3 references Table 2",
             "confidence": 0.82,
             "bidirectional": false
         }}
        ]
       }}

output_schemas:
  entity:
    type: object
    required: ["entities"]
    properties:
      entities:
        type: array
        items:
          type: object
          required: ["name", "type", "description", "confidence"]
          properties:
            name: {type: string}
            type:
              type: string
              enum:
                - SYSTEM
                - SUBSYSTEM
                - COMPONENT
                - PARAMETER
                - PROCEDURE
                - PROCEDURE_STEP
                - CONCEPT
                - DOCUMENT
                - STANDARD
                - ANOMALY
                - TABLE
                - FIGURE
                - ORGANIZATION
                - PERSON
            description: {type: string}
            aliases:
              type: array
              items: {type: string}
              uniqueItems: true
            source_sentence: {type: string}
            confidence:
              type: number
              minimum: 0
              maximum: 1
  relationship:
    type: object
    required: ["relationships"]
    properties:
      relationships:
        type: array
        items:
          type: object
          required: ["source", "type", "target", "description", "confidence"]
          properties:
            source: {type: string}
            type:
              type: string
              enum:
                - PART_OF
                - CONTAINS
                - IS_A
                - DEPENDS_ON
                - CONTROLS
                - MONITORS
                - PROVIDES
                - PROVIDES_POWER_TO
                - SENDS_DATA_TO
                - SUPPORTS
                - REQUIRES
                - CONNECTS_TO
                - TRIGGERS
                - CAUSES
                - REFERENCES
                - PRECEDES
                - REQUIRES_CHECK
                - AFFECTS
                - IMPLEMENTS
                - SIMILAR_TO
                - CAUSED_BY
                - MITIGATED_BY
                - REFERENCES_TABLE
                - REFERENCES_FIGURE
                - DEFINED_IN_TABLE
                - SHOWN_IN_FIGURE
                - CONTAINS_TABLE
                - CONTAINS_FIGURE
                - CROSS_REFERENCES
            target: {type: string}
            description: {type: string}
            evidence: {type: string}
            bidirectional: {type: boolean}
            confidence:
              type: number
              minimum: 0
              maximum: 1

few_shot_examples:
  entity_examples:
    - text: "The Electrical Power Subsystem (EPS) manages battery charging and solar array deployment."
      entities:
        - name: "electrical_power_subsystem"
          type: "SUBSYSTEM"
          description: "Manages electrical power generation, storage, and distribution"
          aliases: ["EPS", "power subsystem", "electrical power system"]
          confidence: 0.95
        - name: "battery_charging"
          type: "PROCEDURE"
          description: "Process of charging system batteries"
          aliases: ["battery charge", "charging procedure"]
          confidence: 0.90
        - name: "solar_array"
          type: "COMPONENT"
          description: "Solar panel array for power generation"
          aliases: ["solar panels", "photovoltaic array"]
          confidence: 0.95
    - text: "NASA's Jet Propulsion Laboratory (JPL) developed the Perseverance rover."
      entities:
        - name: "nasa"
          type: "ORGANIZATION"
          description: "United States federal agency responsible for the civil space program"
          aliases: ["National Aeronautics and Space Administration"]
          confidence: 0.98
        - name: "jet_propulsion_laboratory"
          type: "ORGANIZATION"
          description: "Federally funded research and development center managed by Caltech for NASA"
          aliases: ["JPL"]
          confidence: 0.97
        - name: "perseverance"
          type: "SYSTEM"
          description: "Mars rover designed to explore the Jezero crater"
          aliases: ["Perseverance rover", "Mars 2020"]
          confidence: 0.95
    - text: "Step 3 (Verify Table 2) ensures transponder configuration meets CCSDS uplink standards."
      entities:
        - name: "procedure_step_3"
          type: "PROCEDURE_STEP"
          description: "Verification step prior to antenna deployment"
          aliases: ["step 3"]
          confidence: 0.86
        - name: "table_2"
          type: "TABLE"
          description: "Table referenced for configuration values"
          aliases: ["table 2"]
          confidence: 0.84
        - name: "ccsds_uplink_standard"
          type: "STANDARD"
          description: "Referenced CCSDS uplink requirements"
          aliases: ["CCSDS uplink"]
          confidence: 0.82

  relationship_examples:
    - text: "The battery depends on the solar array for charging during daylight passes."
      relationships:
        - source: "battery"
          type: "DEPENDS_ON"
          target: "solar_array"
          description: "Battery requires solar array output for charging"
          confidence: 0.95
          bidirectional: false
    - text: "The payload controller sends data to the onboard recorder before downlink."
      relationships:
        - source: "payload_controller"
          type: "SENDS_DATA_TO"
          target: "onboard_recorder"
          description: "Payload controller forwards data to recorder"
          confidence: 0.91
          bidirectional: false
    - text: "Procedure step 3 requires check of Table 2 before antenna deployment."
      relationships:
        - source: "procedure_step_3"
          type: "REQUIRES_CHECK"
          target: "table_2"
          description: "Step 3 must verify Table 2 values"
          confidence: 0.88
          bidirectional: false
        - source: "procedure_step_3"
          type: "REFERENCES_TABLE"
          target: "table_2"
          description: "Step 3 references Table 2"
          confidence: 0.82
          bidirectional: false

table_figure_extraction:
  system: |
    You are an expert at extracting structured information from tables and figures in technical
    documents. Your task is to identify tables and figures, extract their metadata, and understand
    their content.

  user_template: |
    Extract table and figure information from the following text:

    Text:
    {chunk_text}

    For each table, provide:
    - Caption/title
    - Table number/identifier
    - Column headers
    - Summary of data
    - Page number

    For each figure, provide:
    - Caption/title
    - Figure number/identifier
    - Type (diagram, chart, schematic, photo)
    - Description of what it shows
    - Page number

    Return JSON:
    {{
      "tables": [
        {{
          "number": "Table 1",
          "caption": "Power Budget Summary",
          "headers": ["Subsystem", "Average Power (W)", "Peak Power (W)"],
          "summary": "Power consumption for all subsystems",
          "page": 15
        }}
      ],
      "figures": [
        {{
          "number": "Figure 3",
          "caption": "Thermal Control System Block Diagram",
          "type": "diagram",
          "description": "Shows thermal control flow and component interactions",
          "page": 22
        }}
      ]
    }}

cross_reference_extraction:
  patterns:
    - 'see section (\\d+\\.?[\\d\\.]*)'
    - 'refer to (?:section|chapter|appendix) (\\d+\\.?[\\d\\.]*)'
    - 'as described in (?:section|chapter) (\\d+\\.?[\\d\\.]*)'
    - 'defined in (?:section|chapter|appendix) (\\d+\\.?[\\d\\.]*)'
    - 'see (?:table|figure) (\\d+)'
